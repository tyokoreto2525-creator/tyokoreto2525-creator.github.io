<div class="blog-post">
  <h3>2. TailsOSの設定</h3>

  <h4>① Tails OSをUSBにインストール（Windows前提）</h4>

  <p>
    準備するもの：8GB以上（推奨：16GB以上）のUSBメモリ ×2本（1本はインストール用、もう1本は本番運用用）、書き込みソフト：balenaEtcher（公式サイトから無料で入手可能）、Windowsパソコン（作業用）
  </p>

  <p>
    手順：Tails公式サイトから、最新版のイメージファイル（例：<code>.img</code> または <code>.img.zip</code>）をダウンロードします。※公式が推奨する形式を選んでください。書き込みソフト balenaEtcher を使って、ダウンロードしたTailsイメージを「インストール用USB」に書き込みます。書き込みが完了したら、PCの電源を落とし、作成した「インストール用USB」を挿して再起動。BIOS/UEFI設定でUSBブートを優先させて起動します。起動が成功すると、Tails OSが立ち上がり、「Tails Installer」という画面が表示されます。
  </p>

  <p>
    「Clone the current Tails（現在のTailsを複製）」を選択し、もう1本の「本番用USBメモリ」を接続して選択します。複製後は、インストール元（最初のUSB）を抜き、本番USBのみを使って起動確認を行いましょう。これにより、本番USBの動作確認と、不必要なブート競合を防げます。
  </p>

  <h4>② Persistentの有効化（保存領域）</h4>

  <p>
    Tails起動後、右上メニューから「Applications」→「Tails Persistent Storage」を選択する。「Set up」をクリックし、強力なパスワードを設定する。(パスワード例：<code>8xJ!p@L93t#VwZ6^BqM2</code> 等ランダムで長く、記号や大小英字・数字を混ぜた構成が理想です。)
  </p>

  <p>
    保存したい項目（例：個人ファイル・暗号鍵・VPN設定など）にチェックを入れて「保存」をクリックします。設定が完了したら一度再起動すると、「Persistent Storage（保存領域）」が使えるようになります。保存領域は、Tails上の「Persistent」フォルダ（場所：ホームフォルダ内）として表示されます。
  </p>

  <hr>

  <p><code>/home/amnesia/Persistent/</code></p>

  <hr>

  <p>
    この中にあるデータだけが、次回以降もUSBに暗号化された状態で残る仕組みです。それ以外の場所に保存したデータは再起動で消えます。
  </p>

  <h4>③ VPN設定の保存（オプション）</h4>

  <p>
    Tailsでは、通常起動するたびに設定がリセットされますが、「Persistent Storage（保存領域）」を利用すれば、VPN接続情報も保存できます。
  </p>

  <p>
    VPN情報を保存する手順：Persistent作成時に「Network Connections」にチェックを入れておきます。これにより、ネットワーク設定が保存可能になります。Tailsが起動したら、以下のディレクトリを作成します（Persistent領域内）
  </p>

  <hr>

  <p><code>/home/amnesia/Persistent/VPN/</code></p>

  <hr>

  <p>
    上記フォルダに、自分のVPNプロバイダから入手した <code>.ovpn</code> 設定ファイルを保存します。画面右上メニューから：Network → Add VPN → Import from file... を選択し、保存した<code>.ovpn</code>ファイルを読み込みます。必要に応じて、ユーザー名・パスワード・証明書（<code>.crt</code>）などの情報を入力し、「保存」をクリックします。次回以降の起動でも、VPNの設定情報はPersistent内に残り、自動的に接続可能になります。
  </p>

  <p>
    補足：VPNの使用は、Tor経由通信に加えた多層匿名化になりますが、設定ミスやVPN事業者のログポリシーによっては逆に匿名性が低下するリスクもあります。「匿名登録可能（メールアドレス不要）」「仮想通貨で支払い可能」「ノーログを監査済み」など、三拍子揃ったVPN（例：Mullvad, IVPNなど）を推奨。国ごとのログ提出義務にも注意すること（例：EU・5Eyes圏外が理想）。
  </p>

  <p>
    検討すべき設定・対策：VPN設定後は、DNSリークやTorのバイパスが発生していないかを確認してください。必要に応じて <code>.ovpn</code> ファイルの設定を編集し、Tor通信と併用するかVPN単独で使うかを明確に運用しましょう。
  </p>

  <h4>① DNSリーク対策</h4>

  <p>
    <code>.ovpn</code>ファイル内に以下を追加しておくことで、DNSリクエストがVPN経由になるよう強制できます。
  </p>

  <hr>

  <p><code>block-outside-dns</code></p>

  <hr>

  <p>
    ※TailsはTor経由通信が前提のため、VPNを使うとTorをバイパスする挙動になりやすい点に注意。
  </p>

  <h4>② Kill Switch（VPN切断時に通信遮断）</h4>

  <p>
    TailsにはデフォルトのKill Switchはありませんが、<code>.ovpn</code>に以下を追加して通信遮断を強化することができます。
  </p>

  <hr>

  <pre><code>ping-restart 10
persist-key
persist-tun</code></pre>

  <hr>

  <p>
    また、強制Tor＋VPNを併用したい場合は、VPN接続確立後に Tor ブラウザを起動すること（VPN over Tor）を明確に意識してください。
  </p>

  <h4>③ VPNがTorを迂回するリスク</h4>

  <p>
    通常のVPN設定では、TailsがTorを使わずVPNだけで通信する構成（Torバイパス）になってしまうことがあります。これを避けるには、
  </p>
  <ul>
    <li>Tailsの「Unsafe Browser（非推奨）」は使わない</li>
    <li>VPNはTorと併用する目的か、単体で使うかを明確にする</li>
    <li>Tor over VPN または VPN over Tor の構成を理解し、用途に応じて選択する</li>
  </ul>
  <p>
    前者（Tor over VPN）は、VPN側に本来のIPが見えるが、Torが匿名化を担う構成。後者（VPN over Tor）は逆にTor出口にVPN通信が流れ、ISPにTor使用が見える。用途に応じた選択と理解が重要。
  </p>

  <p>
    補足：この場合、Tailsの匿名性は保証されません。Tor over VPN（先にVPN、その上にTor）か、VPN over Tor（先にTor、VPN通信をTor内で行う）どちらを構築するのかを明確にした上で設定してください。Tailsでは「Tor over VPN」が現実的です（VPN接続 → Tor起動）。逆は高度なルーティング技術が必要です。
  </p>

  <h4>④ VPNの接続確認</h4>

  <p>
    VPN接続後に <code>ip a</code> または <code>curl ifconfig.me</code> などで「本来のIPが見えていないか」確認する癖をつけましょう。確認後に Tor Browser を開き、<code>https://check.torproject.org</code> で「Torに接続されています」と表示されるか確認。これで VPN → Tor 経由が成立しているかを判断可能。DNSリーク確認には <code>dnsleaktest.com</code> や <code>ipleak.net</code> をTorブラウザから実行するのが有効。IP＋DNSどちらの経路も監視できる。
  </p>

  <p>
    補足：Tor経由の場合は <code>check.torproject.org</code> でTor接続状態を確認。DNSリーク確認は <code>dnsleaktest.com</code> や <code>ipleak.net</code> をTorブラウザ内で実行すると、IPとDNSの両方の漏洩を確認できる。これにより「VPNのみ接続状態」「Tor未経由状態」の誤動作を発見可能。
  </p>

  <h4>③【Tor over VPN】をTailsで実現する手順</h4>

  <p>
    ③Persistent Storageで「Network Connections」を有効化→ これにより、VPN接続情報（<code>.ovpn</code>ファイル）が永続化される準備が整います。VPN企業から <code>.ovpn</code> 設定ファイルを入手→ 信頼できる「ノーログポリシーのVPN事業者（例：Mullvad, ProtonVPNなど）」の公式サイトから、Linux/Tails対応の <code>.ovpn</code> ファイルをダウンロードします。
  </p>

  <p>
    Tails上で接続設定を読み込む→ Tails起動後：Network → Add VPN → Import from file...→ <code>.ovpn</code>ファイルを選択して設定を保存します。VPNに接続してからTorブラウザを起動する。→ 接続確認後（例：<code>ip a</code> や <code>curl ifconfig.me</code>）、Tails内のTor Browserを起動。これで「Tor over VPN」の構成が完成です。
  </p>

  <p>
    補足：<code>.ovpn</code>ファイルの内容に <code>block-outside-dns</code> や <code>persist-key</code> などが含まれているか確認する。VPNのIPアドレスが漏れていないか、Tor Browserや外部IP確認サイトでチェック。
  </p>

  <h4>④ MACアドレスの偽装</h4>

  <p>
    TailsはデフォルトでMACアドレス偽装が有効になっています。起動時のメニュー（グレースクリーン）で「More Options」を選択する。「Hide the computer’s MAC address」→ チェックが入っていればOKです。Torネットワーク経由＋MACアドレス偽装のダブルで匿名性を高める構成です。
  </p>

  <h4>⑤ 緊急シャットダウンボタンの作成（電源即OFF）</h4>

  <p>
    デスクトップで 右クリック → 新しいテキストファイル 名前を <code>emergency_shutdown.desktop</code> にして、内容を以下にする。
  </p>

  <hr>

  <pre><code>[Desktop Entry]
Type=Application
Name=シャットダウン
Exec=sudo poweroff
Icon=system-shutdown
Terminal=false</code></pre>

  <hr>

  <p>
    端末を開いて、以下のコマンドで実行可能にする。
  </p>

  <hr>

  <pre><code>chmod +x ~/Desktop/emergency_shutdown.desktop</code></pre>

  <hr>

  <p>
    アイコンをダブルクリックすると、即シャットダウンが実行されます。物理押収や急な遮断が必要な環境では、スクリプトは Persistent にも保存しておき、アクセスをショートカットにしておくと有効。ホットキーとの連動をした panic スクリプト構成も検討対象。補足：Tailsでは sudo にパスワードが毎回必要です。sudo をパスワード不要にするには <code>/etc/sudoers</code> を編集してNOPASSWD 指定が必要ですが、Tailsは再起動で設定が消えるため永続化できません。よって、「Persistent領域にスクリプトを置き、毎回手動実行する方式」が安全かつ現実的です。
  </p>

  <h4>⑥ Persistentに保存するファイルはすべて暗号化（GPG推奨）</h4>

  <p>
    特に <code>.txt</code>, <code>.conf</code>, <code>.key</code>, <code>.pem</code> などの設定ファイル系はすべて <code>gpg -c</code> で暗号化しておく。公開鍵認証もQR共有や紙保存にして、USBに依存しない構成を心がける。
  </p>

  <hr>

  <pre><code>gpg -c 機密ファイル.txt</code></pre>

  <hr>

  <p>
    → ファイルを暗号化するには、<code>gpg -c ファイル名</code> を実行します。→ ファイルを暗号化するには、<code>gpg -c ファイル名</code> を実行します。
  </p>

  <h4>⑦ RAMゼロ化</h4>

  <p>
    Tails起動時にRAM内容を完全に消去する設定（RAMゼロ化）を有効化するには、起動時オプションに以下を追加する。
  </p>

  <hr>

  <pre><code>mem=erase</code></pre>

  <hr>

  <p>
    補足：この設定はGRUBメニューまたはブートローダーの起動時に編集が必要です。TailsのUSB起動時に、Tab や <code>e</code> を押してカーネルパラメータに追加してください。RAMクリアは不揮発性メモリに対する対策ではありませんが、フォレンジック調査（cold boot攻撃）に対しては効果的です。※これは、電源断後にメモリ内容を物理抽出する「cold boot攻撃」への実用的な防御策のひとつです。冷却されたメモリから復元されるデータを抑止できます。
  </p>

  <p>
    ※GRUBの編集が必要なため、Tails USB作成後にオプション編集が必要。
  </p>

  <pre><code>sudo nano /boot/grub/grub.cfg

mem=erase</code></pre>

  <p>
    ※注意：TailsのGRUBは一時的なものであるため、再起動のたびに編集がリセットされる。恒常化したい場合は、Liveビルド再構成が必要（高度者向け）。さらに、USB自体はラベルなし・無地・小型のものを使用することで物理的特定リスクも軽減できる。
  </p>

  <h4>⑧ Unsafe Browserの無効化（Tor非経由通信の遮断）</h4>

  <p>
    Tailsには「Unsafe Browser」という、Torを経由しない通信が可能なブラウザがデフォルトで用意されていますが、これは匿名性の大きなリスクになります。誤って起動しないよう、起動時に無効化しておきましょう。
  </p>

  <p>
    手順：Tails起動時のグレースクリーンで「More Options」を選択。「Disable Unsafe Browser」にチェックを入れて起動。→ これでそのセッション中、Torを経由しないブラウザが使えなくなり、誤操作リスクが低下します。補足：Persistent化はされないため、毎回起動時にこのオプションを選ぶ必要があります。
  </p>

  <p>
    補足：Tailsは起動時にUnsafe Browserの有効・無効を毎回選ぶ仕様です。Persistent保存は不可。運用時に起動忘れによる情報漏洩を避けるため、起動手順に「Disable Unsafe Browser」を選ぶ操作を毎回確実に取り入れることが重要です。
  </p>

  <h4>⑨ その他の実用的な強化策（オプション）</h4>

  <h5>① QRコードによるGPG公開鍵の一時配布</h5>

  <p>
    GPGの公開鍵をファイルではなくQRコード化し、スマホや別端末で読み取り可能にすることで、USBに鍵ファイルを保存せずにやり取り可能です。
  </p>

  <hr>

  <pre><code>gpg --export -a ユーザー名 | qrencode -o publickey.png</code></pre>

  <hr>

  <p>（qrencodeコマンドが必要）</p>

  <h5>② panicスクリプト（物理的にRAMを即遮断）</h5>

  <p>
    高度なカスタムで、「特定キーを押すとRAMを強制的にゼロクリア＆シャットダウン」するpanicスクリプトを設定する例も存在する。実装例：ホットキーを監視するスクリプト（例：Ctrl + Alt + P）、検知時に <code>sudo poweroff</code> や <code>memwipe.sh</code> などを即実行。例：Ctrl + Alt + P を押すと <code>/home/amnesia/Persistent/memwipe.sh</code> を実行するスクリプトをあらかじめ起動しておくことで、物理押収時の緊急遮断が可能になります。<code>memwipe.sh</code> には <code>sudo swapoff -a && sudo dd if=/dev/zero of=/dev/mem</code> 等のRAM上書きコマンドを記述可能です。
  </p>

  <h5>③ Tailsログイン時のUSB名を無地＆意味のない名前に変更</h5>

  <p>
    外部から見て内容や用途を推測されないようにする。例：「NO_LABEL」「USB123」など無意味な名前に設定。
  </p>

  <h4>⑩ VPN接続の自動化スクリプト化（Tails用）</h4>

  <p>
    前提：<code>.ovpn</code>ファイルはPersistent領域 <code>/home/amnesia/Persistent/VPN/</code> に保存済み。Persistent作成時に「Network Connections」を有効化していること。
  </p>

  <p>
    手順①：VPN接続をNetworkManagerに登録。
  </p>

  <p>
    <code>.ovpn</code>ファイルをGUIから読み込んで保存する（初回のみ）
  </p>

  <hr>

  <pre><code>Network → Add VPN → Import from file... → 保存</code></pre>

  <hr>

  <p>
    保存後、VPN名（例：<code>mullvad-vpn</code>）がNetworkManagerに登録される。
  </p>

  <p>
    手順②：接続スクリプトをPersistentに保存。
  </p>

  <p>
    以下の内容でファイルを作成（例：<code>vpn_auto.sh</code>）
  </p>

  <hr>

  <pre><code>#!/bin/bash
nmcli connection up id "mullvad-vpn"</code></pre>

  <hr>

  <p>
    ※ <code>mullvad-vpn</code> はVPN接続名に応じて変更してください。保存先例：
  </p>

  <hr>

  <p><code>/home/amnesia/Persistent/vpn_auto.sh</code></p>

  <hr>

  <p>
    手順③：スクリプトを実行可能化
  </p>

  <hr>

  <pre><code>chmod +x ~/Persistent/vpn_auto.sh</code></pre>

  <hr>

  <p>
    手順④：起動時に自動実行させる。
  </p>

  <p>
    起動時にスクリプトが自動実行されるようにcrontabを設定する。
  </p>

  <hr>

  <pre><code>crontab -e

@reboot /home/amnesia/Persistent/vpn_auto.sh</code></pre>

  <hr>

  <p>
    補足：動作確認。起動後に <code>ip a</code> または <code>curl ifconfig.me</code> などで、VPNのIPが割り当てられているか確認する。VPN自動接続スクリプト→ <code>nmcli connection up id "VPN名"</code> のスクリプトを作成し、<code>@reboot</code> で自動実行設定する。この仕組みを入れておくことで、Tails起動時にVPNへ自動で接続される状態が実現できます。
  </p>

  <h4>・まとめ</h4>

  <ol>
    <li>Tails USB作成→ balenaEtcherでISOをUSBに焼く／別のUSBに複製</li>
    <li>Persistent作成→ Applications → Persistent Storageで有効化</li>
    <li>VPN設定→ Persistent領域に<code>.ovpn</code>ファイルを保存 → NetworkManagerで読み込み・保存 → Tor起動前に接続確認することで「Tor over VPN」が実現可能。</li>
    <li>MAC偽装→ デフォルトでON、起動時メニュー「More Options」で確認</li>
    <li>緊急ボタン（即シャットダウン）→ <code>.desktop</code>ファイルを作成＋ <code>chmod +x</code> で実行可能化</li>
    <li>RAMゼロ化→ 起動オプションに <code>mem=erase</code> を追加（GRUB編集）</li>
    <li>Unsafe Browserの無効化→ 起動時に「More Options」→「Disable Unsafe Browser」にチェック</li>
    <li>GPG鍵のQRコード化（USBに残さず公開鍵共有）→ <code>gpg --export -a 名前 | qrencode -o ファイル名.png</code></li>
    <li>panicスクリプトの導入（高度者向け）→ ホットキーで即 <code>poweroff</code> またはRAM消去スクリプトを実行</li>
    <li>USB名の無意味化（物理押収対策）→USBラベルには「音楽」「写真」「SystemBack」など、日常的かつ無害な名前を設定すると良い。もしくは無記名（NO_LABEL）＋物理ラベルを剥がすことで識別回避効果が高まる。</li>
  </ol>

  <p>
    Tor未起動のまま通信しない（VPN単体の通信は避ける）。Persistent保存領域を必要最小限にとどめる。USB紛失・押収リスクを常に意識（使用後に安全保管 or 破壊）がない限り、この構成で「インストールから匿名利用開始」までの準備は完成です。
  </p>
</div>
